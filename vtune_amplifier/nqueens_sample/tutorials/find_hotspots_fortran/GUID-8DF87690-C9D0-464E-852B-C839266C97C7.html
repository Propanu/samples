<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0014)about:internet -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta name="DC.Type" content="topic" />
<meta name="DC.Title" content="Resolve Issue" />
<meta name="DC.Relation" scheme="URI" content="GUID-742F5949-4A88-4170-9A20-425DD0CFB029.html" />
<meta name="prodname" content="VTune Amplifier" />
<meta name="version" content="2016" />
<meta name="series" content="" />
<meta name="DC.Format" content="XHTML" />
<meta name="DC.Identifier" content="GUID-8DF87690-C9D0-464E-852B-C839266C97C7" />
<meta name="DC.Language" content="en-US" />
<link rel="stylesheet" type="text/css" href="intel_css_styles.css" />
<title>Resolve Issue</title>
<script src="resources/prism/prism.js"><!----></script>
<link href="resources/prism/prism.css" rel="stylesheet" />
</head>
<body id="GUID-8DF87690-C9D0-464E-852B-C839266C97C7">
 <!-- ==============(Start:NavScript)================= -->
 <script src="NavScript.js" language="JavaScript1.2" type="text/javascript"></script>
 <script language="JavaScript1.2" type="text/javascript">WriteNavLink(0);</script>
 <!-- ==============(End:NavScript)================= -->
<p id="header_text" style="margin-bottom : 20pt"><em>Intel&reg; VTune&#8482; Amplifier</em></p>


<h1 class="topictitle1">Resolve Issue</h1>
<div><p><img id="IMAGE_E15678D995BE4DD3BD710B88DF0C9F14" src="GUID-02914B5D-1A7D-4B4B-8A24-9534BDA714E4-low.gif" /> You identified that the most time-consuming function is 
		<samp class="codeph">nqueens_IP_setqueen</samp>. If you click the 
		<img id="IMAGE_814EE63272E141C484EA1FA647D252E9" src="GUID-66F5A54E-83EC-4E60-AD9A-83481F49715D-low.jpg" /><b class="uicontrol">Source Editor</b> button from the 
		<strong>Source</strong> pane, the VTune Amplifier opens the source 
		<samp class="codeph">nqueens_parallel.f90</samp> file at the hotspot line in the
		default code editor. You see that the OpenMP* cycle is calling the recursive 
		<samp class="codeph">setQueen</samp> function that initializes the 
		<samp class="codeph">queens</samp> array. To avoid a data race, this array is copied
		in each thread (see line 127): 
	 </p>
<div class="Note"><h3 class="NoteTipHead">Note</h3> <p>Depending on the sample code version, your source line numbers may
		  slightly differ from the numbers provided in this tutorial. 
		</p>
</div>
<p><img id="IMAGE_DFA449B2D29F4FE5BAFB0DAAFE687F94" src="GUID-C3B0CEEA-BF4E-40D2-A0A2-FC44CC2FE142-low.gif" /></p>
<p>This means that the number of local copies is equal to the number of
		threads. Since the function is recursive, the array is also copied in every
		function call, which is unnecessary and creates a big overhead. 
	 </p>
<p>To resolve this issue, you may enable OpenMP to make a copy of the array
		per thread. To do this: 
	 </p>
<ol id="GUID-66C5A226-8FE7-4644-A6C1-A8959E1D5B38"><li id="LI_9F2021B162CD454B944D069A8001608E"><p>Comment out lines 124 and 127. 
		  </p>
<p><img id="IMAGE_6057A139F69D47E2832935C0B3996736" src="GUID-F1538017-4FBE-4DA3-B2CD-DEB04B10F71D-low.gif" /></p>
</li>
<li id="LI_2C30B225478F4CC481BC74B95895E496"><p>Search and replace all 
			 <samp class="codeph">lcl_queens</samp> entries with 
			 <samp class="codeph">queens</samp>. 
		  </p>
</li>
<li id="LI_E6BF5F080B754A14A5824A44373F1641"><p>Edit line 159 to add the 
			 <samp class="codeph">PRIVATE(queens)</samp> directive. 
		  </p>
<p>This enables the OpenMP run-rime to create a private copy of the
			 array for each thread. 
		  </p>
<p><img id="IMAGE_536678B203644964B0E286897739B07B" src="GUID-DA1A1419-2D2F-4716-9298-995FE7075BD6-low.gif" /></p>
</li>
<li id="LI_769C86743C764356BD569D3B1A97123E"><p>Save the changes made in the source file. 
		  </p>
</li>
<li id="LI_D6DD15F538E3482393B338EA798DE405"><p>Browse to the directory where you extracted the sample code (for
			 example,<samp class="codeph"> /home/vtune/nqueens_fortran/linux</samp>). 
		  </p>
</li>
<li id="LI_1605EFBB95924650A71FC645F9AF6C45"><p>Rebuild your target in the release mode using the make command as
			 follows: 
		  </p>
<p><samp class="codeph">$ make clean</samp></p>
<p><samp class="codeph">$ make 
			 </samp></p>
<p>The 
			 <samp class="codeph">nqueens_parallel</samp> application is rebuilt. 
		  </p>
</li>
<li id="LI_02A55E532FFB44C58F6769043F3DD4C3"><p>Run 
			 <samp class="codeph">nqueens_parallel</samp> as follows: 
		  </p>
<p><samp class="codeph">./nqueens_parallel
				15</samp></p>
<p><img id="IMAGE_7BCC76282C204BD299D721C71002BF72" src="GUID-CAD7F7D2-9498-4BE7-B532-E999936502A5-low.gif" /></p>
<p><span>System</span> runs 
			 <samp class="codeph">nqueens_parallel</samp>. Note that the execution
			 time has reduced from 
			 <span> 256710</span> ms to 
			 <span>56566</span> ms. This means that the proposed
			 solution gives 
			 <span>200144</span> ms of CPU time reduction. 
		  </p>
</li>
</ol>
<p>To identify other possible performance issues, you may run the
		Concurrency analysis and see how effectively your application is parallelized. 
	 </p>
<div class="section" id="GUID-79A5D5A4-A122-4A97-B91B-ED95893B9394"><h2 class="sectiontitle">Next Step</h2><p><a href="GUID-29E0EADE-D0EC-4C35-AECA-D93936C3C938.html">Run Concurrency
			 Analysis</a></p>
</div>
</div>

<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a href="GUID-742F5949-4A88-4170-9A20-425DD0CFB029.html">Finding Hotspots</a></div>
</div>
<div></div>
</body>
</html>
